#include <TinyScreen.h>
#include <SdFat.h>
#include <Wire.h>
#include <SPI.h>

TinyScreen display = TinyScreen(0);

SdFat sd;
SdFile dataFile;
SdFile fileInfo;

void setup(void) {
  Wire.begin();
  display.begin();
  Serial.begin(115200);
  if (!sd.begin(10,SPI_FULL_SPEED)) {
    Serial.println(F("Card failed"));
    while(1);
  }
}

void loop() {
  sd.vwd()->rewind();
  while(fileInfo.openNext(sd.vwd(), O_READ)){
    char filename[12];
    if(fileInfo.isFile() && fileInfo.getFilename(filename)){
      int len=strlen(filename)-4;
      if(!strcmp(filename+len,".TSV"))
        playVideo(filename,0);
    }
    fileInfo.close();
  }
}


void playVideo(char * filename,char skip){
  Serial.println(filename);
  uint8_t buffer[512];
  if(!dataFile.open(filename, O_READ)) {
    Serial.println(F("Error opening file!"));
    delay(100);
    return;
  }
  display.goTo(0, 0);
  unsigned char t=0;
  while(dataFile.available()) {
    //if(t++&skip)dataFile.seek(dataFile.position()+(96*64));//switch to SdFat
    unsigned long timer=millis();
    for(int i=0; i<12 && dataFile.available(); i++){
      dataFile.read(buffer,512);
      display.startData();
      display.writeBuffer(buffer,512);
      display.endTransfer();
    }
    timer=millis()-timer;
    Serial.println(timer);
  }
  dataFile.close();
}
